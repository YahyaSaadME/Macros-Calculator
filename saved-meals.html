<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Meals - AI-Powered Macro Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="View and manage your saved meals">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Macro Calc">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon Meta Tags -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .meal-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <div class="glass-card rounded-3xl p-6 mb-6">
                <div class="flex items-center justify-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                        <i data-lucide="bookmark" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">Saved Meals</h1>
                </div>
                <p class="text-lg text-white opacity-90">Manage and view your saved meal collections</p>
                
                <!-- Navigation -->
                <div class="mt-6 flex justify-center space-x-4 flex-wrap gap-2">
                    <button id="backBtn" class="bg-white bg-opacity-20 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-opacity-30 transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Back to Calculator
                    </button>
                    <button id="addNewMealBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-green-700 transition-colors duration-200 flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Add New Meal
                    </button>
                </div>
            </div>
        </header>

        <!-- Meals Grid -->
        <div id="mealsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Meals will be rendered here dynamically -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="glass-card rounded-3xl p-12 max-w-md mx-auto">
                <i data-lucide="bookmark-x" class="w-16 h-16 text-white mx-auto mb-4"></i>
                <h3 class="text-2xl font-bold text-white mb-2">No Saved Meals Yet</h3>
                <p class="text-white opacity-80 mb-6">Start by adding some food items and saving your first meal.</p>
                <button onclick="window.location.href='index.html'" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-colors duration-200 flex items-center gap-2 mx-auto">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    Go to Calculator
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center space-y-4 max-w-sm w-full">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-600"></p>
            <button id="closeModalBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Add Food to Meal Modal -->
    <div id="addFoodModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-4 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800 text-center">Add Food to Meal</h3>
            <div class="space-y-4">
                <div>
                    <label for="modalFoodName" class="block text-sm font-medium text-gray-600 mb-1">Food Name</label>
                    <input type="text" id="modalFoodName" placeholder="e.g., Apple, Chicken Breast" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                </div>
                <div>
                    <label for="modalFoodWeight" class="block text-sm font-medium text-gray-600 mb-1">Weight (g)</label>
                    <input type="number" id="modalFoodWeight" placeholder="100" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                </div>
                <div class="flex space-x-2">
                    <button id="modalAddFoodBtn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-purple-700 transition-colors duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add Food
                    </button>
                    <button id="cancelAddFoodBtn" class="flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-700 transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let savedMeals = [];
        let currentMealIndex = -1;
        const apiUrl = "https://api.groq.com/openai/v1/chat/completions";

        // DOM elements
        const mealsContainer = document.getElementById('mealsContainer');
        const emptyState = document.getElementById('emptyState');
        const alertModal = document.getElementById('alertModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addFoodModal = document.getElementById('addFoodModal');
        const modalFoodName = document.getElementById('modalFoodName');
        const modalFoodWeight = document.getElementById('modalFoodWeight');
        const modalAddFoodBtn = document.getElementById('modalAddFoodBtn');
        const cancelAddFoodBtn = document.getElementById('cancelAddFoodBtn');
        const backBtn = document.getElementById('backBtn');
        const addNewMealBtn = document.getElementById('addNewMealBtn');

        // Utility functions
        function getapi() {
            return localStorage.getItem('GROQ');
        }

        function showModal(title, message) {
            modalTitle.textContent = title;
            if (typeof message === 'string') {
                modalMessage.innerHTML = message;
            } else {
                modalMessage.textContent = '';
                modalMessage.appendChild(message);
            }
            alertModal.classList.remove('hidden');
        }

        function saveToLocal() {
            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
        }

        function loadFromLocal() {
            const meals = localStorage.getItem('savedMeals');
            if (meals) savedMeals = JSON.parse(meals);
        }

        // Render meals
        function renderMeals() {
            mealsContainer.innerHTML = '';
            
            if (savedMeals.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            savedMeals.forEach((meal, index) => {
                const mealCard = document.createElement('div');
                mealCard.className = 'meal-card rounded-2xl p-6 shadow-lg';
                
                // Calculate totals
                let totalCalories = 0, totalProtein = 0, totalFat = 0, totalCarbs = 0;
                meal.foods.forEach(food => {
                    totalCalories += food.calories || 0;
                    totalProtein += food.protein || 0;
                    totalFat += food.fat || 0;
                    totalCarbs += food.carbs || 0;
                });

                const date = new Date(meal.timestamp).toLocaleDateString();
                
                mealCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Meal #${index + 1}</h3>
                            <p class="text-sm text-gray-500">${date}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-meal-btn bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors" data-index="${index}">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-meal-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors" data-index="${index}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Macro Totals -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-500">Calories</p>
                            <p class="text-lg font-bold text-blue-600">${totalCalories.toFixed(0)}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-500">Protein</p>
                            <p class="text-lg font-bold text-green-600">${totalProtein.toFixed(1)}g</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-500">Fat</p>
                            <p class="text-lg font-bold text-red-600">${totalFat.toFixed(1)}g</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-500">Carbs</p>
                            <p class="text-lg font-bold text-purple-600">${totalCarbs.toFixed(1)}g</p>
                        </div>
                    </div>
                    
                    <!-- Food Items -->
                    <div class="space-y-2 mb-4">
                        <h4 class="font-semibold text-gray-700 text-sm">Foods (${meal.foods.length}):</h4>
                        ${meal.foods.slice(0, 3).map(food => 
                            `<div class="text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg flex justify-between">
                                <span>${food.foodName}</span>
                                <span class="text-gray-400">${food.weight}g</span>
                            </div>`
                        ).join('')}
                        ${meal.foods.length > 3 ? `<div class="text-xs text-gray-500 text-center">+${meal.foods.length - 3} more items</div>` : ''}
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button class="view-details-btn flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center justify-center gap-2" data-index="${index}">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            View Details
                        </button>
                        <button class="add-food-btn bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition-colors" data-index="${index}">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                mealsContainer.appendChild(mealCard);
            });
            
            // Initialize Lucide icons for new elements
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Add event listeners
            attachEventListeners();
        }

        function attachEventListeners() {
            // Delete meal buttons
            document.querySelectorAll('.delete-meal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (confirm('Are you sure you want to delete this meal?')) {
                        savedMeals.splice(index, 1);
                        saveToLocal();
                        renderMeals();
                    }
                });
            });

            // Add food buttons
            document.querySelectorAll('.add-food-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showAddFoodModal(index);
                });
            });

            // View details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showMealDetailsModal(savedMeals[index], index + 1);
                });
            });
        }

        function showAddFoodModal(mealIndex) {
            currentMealIndex = mealIndex;
            modalFoodName.value = '';
            modalFoodWeight.value = '';
            addFoodModal.classList.remove('hidden');
        }

        function showMealDetailsModal(meal, mealNumber) {
            // Collect all unique macro keys
            const macroSet = new Set();
            meal.foods.forEach(food => {
                Object.keys(food).forEach(key => {
                    if (!['foodName','weight','sodium','potassium','calcium','iron'].includes(key.toLowerCase())) {
                        macroSet.add(key);
                    }
                });
            });
            const macros = Array.from(macroSet);

            let html = `
                <div class='fixed inset-0 flex items-center justify-center z-50 p-4'>
                    <div style="width:95vw;max-width:1100px;max-height:85vh;overflow:auto;background:rgba(255,255,255,0.98);box-shadow:0 4px 32px rgba(0,0,0,0.2);border-radius:2rem;padding:2rem;">
                        <div class='w-full overflow-x-auto'>
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Meal #${mealNumber} Details</h2>
                                <button onclick='document.getElementById("closeModalBtn").click()' class='bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-full p-2'>
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <table class='w-full border border-gray-200 rounded-2xl text-base bg-white shadow-lg'>
                                <thead>
                                    <tr>
                                        <th class='p-4 border-b-2 border-gray-300 bg-purple-100 text-lg font-bold text-left sticky top-0 z-10 rounded-tl-2xl'>Nutrient</th>`;
            
            meal.foods.forEach((food, idx) => {
                html += `<th class='p-4 border-b-2 border-gray-300 bg-purple-100 text-lg font-bold text-center sticky top-0 z-10'>${food.foodName}<br><span class='text-xs text-gray-500'>(${food.weight}g)</span></th>`;
            });
            
            html += `<th class='p-4 border-b-2 border-gray-300 bg-purple-100 text-lg font-bold text-center sticky top-0 z-10 rounded-tr-2xl'>Total</th></tr></thead><tbody>`;
            
            macros.forEach((macro, rowIdx) => {
                html += `<tr class='${rowIdx % 2 === 0 ? 'bg-white' : 'bg-purple-50'}'>
                        <td class='p-3 border-b border-gray-100 font-semibold capitalize'>${macro}</td>`;
                
                let total = 0;
                meal.foods.forEach(food => {
                    let val = food[macro];
                    if (val !== undefined && typeof val === 'number') total += val;
                    html += `<td class='p-3 border-b border-gray-100 text-center text-purple-700'>${val !== undefined ? (typeof val === 'number' ? val.toFixed(1) : val) : '-'}</td>`;
                });
                
                html += `<td class='p-3 border-b border-gray-100 text-center font-bold text-purple-800'>${total.toFixed(1)}</td></tr>`;
            });
            
            html += `</tbody></table>
                    </div>
                    <div class='flex justify-center mt-6 w-full'>
                        <button onclick='document.getElementById("closeModalBtn").click()' class='bg-purple-600 text-white font-bold py-3 px-10 rounded-2xl shadow-lg hover:bg-purple-700 text-lg transition-all duration-200'>Close</button>
                    </div>
                </div>
            </div>`;
            
            showModal('', html);
        }

        async function addFoodToMeal() {
            const foodName = modalFoodName.value.trim();
            const weight = parseFloat(modalFoodWeight.value);

            if (!foodName || isNaN(weight) || weight <= 0) {
                showModal('Invalid Input', 'Please enter a valid food name and weight.');
                return;
            }

            const api = getapi();
            if (!api) {
                showModal('API Key Required', 'Please set your Groq API key in the main calculator first.');
                return;
            }

            // Show loading state
            modalAddFoodBtn.disabled = true;
            modalAddFoodBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Adding...';

            const userPrompt = `What are the calories (kcal), protein (g), fat (g), vitamins (mg), and all other nutrients (like carbs, fiber, sugar) for ${weight}g of ${foodName}? Provide the data in a simple JSON object with all available nutrients as keys. Do not include any explanation or markdown.`;
            const systemPrompt = `Your sole purpose is to provide nutritional information for a food item in a JSON object. The keys must include at least 'foodName', 'calories', 'protein', 'fat', and 'vitamins', and any other nutrients if available (e.g., carbs, fiber, sugar, sodium). The values for all nutrients must be numbers except 'foodName'. Do not include any other text, explanation, or markdown. If you cannot find the data, set all nutritional values to 0.`;

            const payload = {
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                model: "llama-3.1-8b-instant",
                temperature: 1,
                max_completion_tokens: 1024,
                top_p: 1,
                stream: false
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${api}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API error');
                
                const result = await response.json();
                let content = result.choices?.[0]?.message?.content;
                
                if (content) {
                    if (content.startsWith('```')) {
                        content = content.replace(/^```[a-zA-Z]*\n?|```$/g, '').trim();
                    }
                    const parsedData = JSON.parse(content);
                    parsedData.weight = weight;
                    
                    savedMeals[currentMealIndex].foods.push(parsedData);
                    saveToLocal();
                    renderMeals();
                    addFoodModal.classList.add('hidden');
                    showModal('Food Added', 'The food item has been added to your meal successfully!');
                } else {
                    showModal('API Error', 'No content returned from API.');
                }
            } catch (error) {
                showModal('API Error', 'Failed to fetch nutritional data. Please try again later.');
            }

            // Reset button state
            modalAddFoodBtn.disabled = false;
            modalAddFoodBtn.innerHTML = '<i data-lucide="plus" class="w-4 h-4"></i> Add Food';
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Event listeners
        backBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        addNewMealBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        closeModalBtn.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        modalAddFoodBtn.addEventListener('click', addFoodToMeal);

        cancelAddFoodBtn.addEventListener('click', () => {
            addFoodModal.classList.add('hidden');
        });

        // Initialize
        loadFromLocal();
        renderMeals();
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>
</html>